<!DOCTYPE html>
<!-- saved from url=(0133)https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252"><title>CAB202 Topic 9 – Timers and Interrupts</title>

	<style type="text/css">
		
			body {
				max-width: 50em;
				/* font-family: sans-serif; */
				margin: auto;
				line-height: 1.4em;
				background-color: #F1F1F1;
			}
		

		.indent {
			margin-left: 0.6cm;
		}

		.codeblock {
			font-size: +1;
			font-family: monospace;
			font-weight: bold;
			background-color: #303030;
			color: #dcdcdc;
			/* font-size: large; */
		}

		.codeDiv {
			overflow: scroll;
			border: 1px solid gray;
		}

		pre {
			border: 1px solid gray;
			padding: 6pt;
			width: 100%;
		}

		textarea {
			margin-top: 6pt;
		}

		td {
			/* width: 4in; */
			vertical-align: top;
		}

		code {
			font-size: medium;
			font-weight: bold;
		}

		li {
			margin-bottom: 6pt;
		}

		li ul {
			margin-top: 6pt;
		}

		.section {
			margin-left: 0.6cm;
		}

		.subsection {
			margin-left: 0.6cm;
		}

		span.li  {display: list-item; margin-left: 0.6cm}

		span.li2  {display: list-item; margin-left: 1.2cm}

		td.truth_table { text-align: center; width: 1cm; vertical-align: middle; }

		div.truth_table_container { display: inline-block; width: 5.5cm; vertical-align: top; text-align: center; }
		td.truth_value { background-color: #dddddd; }

		.sc0 {
	}
	.sc2 {
		color: #1E9AE0;
	}
	.sc4 {
		color: #FF3A83;
	}
	.sc5 {
		color: #F6F080;
	}
	.sc6 {
		color: #55E439;
	}
	.sc9 {
		color: cyan;
	}
	.sc10 {
		color: #FFAA00;
	}
	.sc11 {
		color: #F8F8F8;
	}
	.sc16 {
		color: #FFAA00;
	}
	</style>
</head><body><h1 class="document_title">CAB202 Topic 9 – Timers and Interrupts</h1>
<p>Authors:</p>
	<ul>
<li>Luis Mejias, Lawrence Buckingham QUT (2020)</li>
</ul>
	
    <h2><a name="_contents">Contents</a></h2>
    
	<ul>
			<li> 
	<a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#roadmap" title="roadmap">Roadmap</a>
	
			
	
	
	
	
	</li>
		
			<li> 
	<a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#format" title="format">References</a>
	
			
	
	
	
	
	</li>
		
			<li> 
	<a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#de_bouncing" title="de_bouncing">De-bouncing (a problem that can be solved with interrupts)</a>
	
			
	
	
	    <ul>
			    <li>
    
	<a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#debounce_problem" title="debounce_problem">The problem</a>
    
    
		  </li>
	        
			    <li>
    
	<a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#debounce_soln_1" title="debounce_soln_1">Delay-based de-bouncing (which is not very good)</a>
    
    
					<ul>
			    <li><a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#dbs1_idea" title="dbs1_idea">Idea</a>
    </li>
	        
			    <li><a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#dbs1_impl" title="dbs1_impl">Implementation</a>
    </li>
	        
			    <li><a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#dbs1_disc" title="dbs1_disc">Pros and Cons</a>
    </li>
	        </ul>
	
	</li>
	        
			    <li>
    
	<a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#debounce_soln_2" title="debounce_soln_2">Non-blocking de-bouncing (which is much better but not quite ideal)</a>Æ’
    
    
					<ul>
			    <li><a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#dbs1_idea" title="dbs1_idea">Idea</a>
    </li>
	        
			    <li><a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#dbs1_impl" title="dbs1_impl">Implementation</a>
    </li>
	        
			    <li><a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#dbs1_disc" title="dbs1_disc">Pros and Cons</a>
    </li>
	        </ul>
	
	</li>
	        
			    <li>
    
	<a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#debounce_conclusion" title="debounce_conclusion">De-bouncing conclusion</a>
    
    
		  </li>
	        </ul>
	
	
	
	</li>
		
			<li> 
	<a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#timers" title="timers">ATMega328P Timers</a>
	
			
	
	
	    <ul>
			    <li>
    
	<a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#timer_intro" title="timer_intro">Timer Introduction</a>
    
    
		  </li>
	        
			    <li>
    
	<a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#timer0_registers" title="timer0_registers">Timer0 registers (Datasheet, Section 15.9)</a>
    
    
		  </li>
	        
			    <li>
    
	<a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#timer0" title="timer0">Case study: Set Up and Read Time From Timer0</a>
    
    
		  </li>
	        </ul>
	
	
	
	</li>
		
			<li> 
	<a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#interrupt" title="interrupt">The Timer Overflow Interrupt</a>
	
			
	
	
	    <ul>
			    <li>
    
	<a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#interrupt_caveat" title="interrupt_caveat">Caveat</a>
    
    
		  </li>
	        
			    <li>
    
	<a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#whats_an_interrupt" title="whats_an_interrupt">What’s an interrupt?</a>
    
    
		  </li>
	        
			    <li>
    
	<a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#timer_overflow_demo" title="timer_overflow_demo">Implementing Timer Overflow ISR</a>
    
    
		  </li>
	        </ul>
	
	
	
	</li>
		
			<li> 
	<a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#appendices" title="appendices">Appendices</a>
	
			
	
	
	    <ul>
			    <li><a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#uart_interrupt">Appendix 1: Interrupt-based UART</a></li>
			    <li><a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#packed_boolean_array" title="packed_boolean_array">Appendix 2: Bit-packed boolean arrays</a>
			      
			      
	      </li>
	        
			    <li>
    
	<a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/CAB202-Topic09-Notes.html#cheat_sheet" title="cheat_sheet">Appendix 3: Digital I/O Cheat Sheet</a>
    
    
					</li>
	        </ul>
	
	
	
	</li>
		
</ul>

	<hr>
	
	

    
		<h2><a name="roadmap">Roadmap</a></h2>
		<div class="section">
		<p><em>Previously:</em></p>
		<ol start="7">
		  <li>AVR ATMega328P Introduction to Microcontrollers; Digital Input/Output </li>
		  <li>Serial Communication – communicating with another computer/microcontroller</li>
</ol>
		<p><em>This week:</em></p>
		<ol start="9">
		  <li><b>Debouncing, Timers and Interrupts. Asynchronous programming.</b></li>
</ol>
		<p><em>Still to come:</em></p>
		<ol start="10"><li>Analogue to Digital Conversion; Pulse Width Modulation (PWM); Assignment 2 Q&amp;A..</li>
<li>LCD Display, sending digital signals to a device.</li>
</ol>
</div>
		<hr>
	
	

    
		<h2><a name="format">References</a></h2>
		<div class="section">
		<p>Recommended reading:</p>

		<ul>
		  <li>Blackboard&#8594;Learning Resources&#8594;Microcontrollers&#8594;atmega328P_datasheet.pdf.</li>
</ul>
	</div>
		<hr>
	
	

    
		<h2><a name="de_bouncing">De-bouncing (a problem that can be solved with interrupts)</a></h2>
		<div class="section">
		
	
    
		<h3><a name="debounce_problem">The problem</a></h3>
		<div class="subsection">
			<p>Switches are prone to a phenomenon known as <em>bouncing</em>, in which spurious “click” events are detected.</p>

			<ul><li>Consider a pull-up resistor:
				<p style="margin-left=0.5in;">
    
    <img src="./CAB202 Topic 9 – Timers and Interrupts_files/Switch.png" width="153" height="201" alt="Representation of switch"></p>
				</li>
<li>When the switch opens and closes, current flows in an interrupted pattern while the connection is made, then settles to either on or off.
				<p style="margin-left=0.5in;">
    
    <img src="./CAB202 Topic 9 – Timers and Interrupts_files/Current.png" width="320" height="239" alt="Representation of switch"></p>
			  </li>
<li>Bouncing matters when we want precise recognition of “click” events.
				<ul><li>A button click is recognised when a switch is <em>pressed</em> and then <em>released</em> as part of a single gesture.</li>
<li>This corresponds to a switch transitioning from <em>open</em> to <em>closed</em> and then back to <em>open</em>.</li>
</ul></li>
</ul>
			<p>The <code>example1.c, BounceDemo</code> program illustrates bouncing.
</p>
		  <pre style="line-height: 1; background: #0f140f; color: #BDAE9D; font-family: monospace; max-width: 100%;"><span style="color: #ff0007; font-weight: bold; font-style: italic; background-color: #0f140f">#define F_CPU (16000000UL</span>)
		 
<span style="color: #ff0007; font-weight: bold; font-style: italic; background-color: #0f140f">#include &lt;avr/io.h&gt;</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">/*</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *  Setting data directions in a data direction register (DDR)</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *  Setting, clearing, and reading bits in registers.</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *	reg is the name of a register; pin is the index (0..7)</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *  of the bit to set, clear or read.</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *  (WRITE_BIT is a combination of CLEAR_BIT &amp; SET_BIT)</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> */</span>

<span style="color: #ff0007;font-weight: bold;">
#define SET_BIT(reg, pin)		    (reg) |= (1 &lt;&lt; (pin))
#define CLEAR_BIT(reg, pin)		  (reg) &amp;= ~(1 &lt;&lt; (pin))
#define WRITE_BIT(reg, pin, value)   (reg) = (((reg) &amp; ~(1 &lt;&lt; (pin))) | ((value) &lt;&lt; (pin)))
#define BIT_VALUE(reg, pin)		  (((reg) &gt;&gt; (pin)) &amp; 1)
#define BIT_IS_SET(reg, pin)	     (BIT_VALUE((reg),(pin))==1)
</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">//Functions declaration</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">setup</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">);
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">process</span>(<span style="color: #cdcaa9; font-weight: bold">void</span>);<span style="color: #cdcaa9; font-weight: bold">
void</span> <span style="color: #ff0086; font-weight: bold">uart_init</span>(<span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">int</span> ubrr)</span><span style="color: #ffffff"></span>;
<span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ff0086; font-weight: bold">uart_getchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span>;<span style="color: #ffffff"></span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">data)</span>;<span style="color: #ffffff"></span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putstring</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">*</span> <span style="color: #ffffff">s)</span>;

<span style="color: #008800; font-style: italic; background-color: #0f140f">//uart definitions</span>
<span style="color: #ff0007; font-weight: bold; font-style: italic; background-color: #0f140f">#define BAUD (9600)
</span><span style="color: #ff0007; font-weight: bold; font-style: italic; background-color: #0f140f">#define MYUBRR (F_CPU/16/BAUD-1</span>)

<span style="color: #008800; font-style: italic; background-color: #0f140f"></span><span style="color: #ff0007; font-weight: bold; font-style: italic; background-color: #0f140f"></span>
<span style="color: #008800; font-style: italic; background-color: #0f140f">//to store button press count</span>
<span style="color: #cdcaa9; font-weight: bold">uint16_t</span> <span style="color: #ffffff">counter</span> <span style="color: #ffffff">=</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">;</span>
 

<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">setup</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
	
	<span style="color: #ffffff">uart_init(MYUBRR);</span>

	<span style="color: #008800; font-style: italic; background-color: #0f140f">// Enable B5 as output, led on B5</span>
	<span style="color: #ffffff">SET_BIT(DDRB,</span> <span style="color: #0086f7; font-weight: bold">5</span><span style="color: #ffffff">);</span>
    <span style="color: #ffffff"></span><span style="color: #0086f7; font-weight: bold"></span><span style="color: #ffffff"></span>
  
   <span style="color: #008800; font-style: italic; background-color: #0f140f">   // Enable D6 and D7 as inputs</span>
   <span style="color: #ffffff">    CLEAR_BIT(DDRD,</span><span style="color: #0086f7; font-weight: bold">6</span><span style="color: #ffffff">);</span>
    <span style="color: #ffffff">   CLEAR_BIT(DDRD,</span><span style="color: #0086f7; font-weight: bold">7</span><span style="color: #ffffff">);</span>

<span style="color: #ffffff">}</span>

<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">process</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
  
   <span style="color: #008800; font-style: italic; background-color: #0f140f">//define a buffer to be sent</span>
    <span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">temp_buf[</span><span style="color: #0086f7; font-weight: bold">64</span><span style="color: #ffffff">];</span>
  
  <span style="color: #ffffff">  snprintf(</span> <span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">*)temp_buf,</span> <span style="color: #fb660a; font-weight: bold">sizeof</span><span style="color: #ffffff">(temp_buf),</span> <span style="color: #0086d2">"%d\n"</span><span style="color: #ffffff">,</span> <span style="color: #ffffff">counter</span> <span style="color: #ffffff">);</span>
  
  
  <span style="color: #008800; font-style: italic; background-color: #0f140f">//detect pressed switch on D7</span>
  <span style="color: #fb660a; font-weight: bold">if</span> <span style="color: #ffffff">(BIT_IS_SET(PIND,</span><span style="color: #0086f7; font-weight: bold">7</span><span style="color: #ffffff">)){</span>
    
    <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(</span> <span style="color: #ffffff">BIT_IS_SET(PIND,</span> <span style="color: #0086f7; font-weight: bold">7</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
	  <span style="color: #008800; font-style: italic; background-color: #0f140f">// Block until switch released.</span>
	<span style="color: #ffffff">}</span>
   
   <span style="color: #008800; font-style: italic; background-color: #0f140f">//increment count</span>
	<span style="color: #ffffff">counter++;</span>
    
  <span style="color: #ffffff">}</span>
  
    <span style="color: #008800; font-style: italic; background-color: #0f140f">//detect presed switch on D6</span>
  <span style="color: #fb660a; font-weight: bold">if</span> <span style="color: #ffffff">(BIT_IS_SET(PIND,</span><span style="color: #0086f7; font-weight: bold">6</span><span style="color: #ffffff">)){</span>
   
   <span style="color: #008800; font-style: italic; background-color: #0f140f">//send serial data</span>
	<span style="color: #ffffff">uart_putstring(temp_buf);</span>
    
    <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(</span> <span style="color: #ffffff">BIT_IS_SET(PIND,</span> <span style="color: #0086f7; font-weight: bold">6</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
		<span style="color: #008800; font-style: italic; background-color: #0f140f">// Block until switch released.</span>
		<span style="color: #ffffff">}</span>
    
    <span style="color: #ffffff">}</span>
  
   <span style="color: #008800; font-style: italic; background-color: #0f140f">//flash LED every time increments of 5 occur</span>
    <span style="color: #fb660a; font-weight: bold">if</span><span style="color: #ffffff">(counter%</span><span style="color: #0086f7; font-weight: bold">5</span> <span style="color: #ffffff">==</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">)</span>
      <span style="color: #ffffff">PORTB^=(</span><span style="color: #0086f7; font-weight: bold">1</span><span style="color: #ffffff">&lt;&lt;PINB5);</span>
  
  
<span style="color: #ffffff">}</span>

<span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ff0086; font-weight: bold">main</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>

	<span style="color: #ffffff">setup();</span>

	<span style="color: #fb660a; font-weight: bold">for</span> <span style="color: #ffffff">(</span> <span style="color: #ffffff">;;</span> <span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
		<span style="color: #ffffff">process();</span>
		<span style="color: #ffffff"></span><span style="color: #0086f7; font-weight: bold"></span><span style="color: #ffffff"></span>
	<span style="color: #ffffff">}</span>
<span style="color: #ffffff">}</span>




<span style="color: #008800; font-style: italic; background-color: #0f140f">/*  ****** serial uart definitions ************ */</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Initialize the UART</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_init</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">ubrr)</span> <span style="color: #ffffff">{</span>
	
	<span style="color: #ffffff">UBRR0H</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">)(ubrr&gt;&gt;</span><span style="color: #0086f7; font-weight: bold">8</span><span style="color: #ffffff">);</span>
    <span style="color: #ffffff">UBRR0L</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">)(ubrr);</span>
	<span style="color: #ffffff">UCSR0B</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span> <span style="color: #ffffff">&lt;&lt;</span> <span style="color: #ffffff">RXEN0)</span> <span style="color: #ffffff">|</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span> <span style="color: #ffffff">&lt;&lt;</span> <span style="color: #ffffff">TXEN0);</span>
	<span style="color: #ffffff">UCSR0C</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff"></span><span style="color: #0086f7; font-weight: bold"></span><span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">3</span><span style="color: #ffffff">&lt;&lt;UCSZ00);</span>
	
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Transmit a data</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">data)</span> <span style="color: #ffffff">{</span>
	
    <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(!(</span> <span style="color: #ffffff">UCSR0A</span> <span style="color: #ffffff">&amp;</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span><span style="color: #ffffff">&lt;&lt;UDRE0)));</span> <span style="color: #008800; font-style: italic; background-color: #0f140f">/* Wait for empty transmit buffer*/</span>
    
  	<span style="color: #ffffff">UDR0</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">data;</span>            <span style="color: #008800; font-style: italic; background-color: #0f140f">/* Put data into buffer, sends the data */</span>
         	
<span style="color: #ffffff">}</span>
			

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Receive data</span>
<span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ff0086; font-weight: bold">uart_getchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>

  <span style="color: #cdcaa9; font-weight: bold"></span><span style="color: #ffffff"></span><span style="color: #0086f7; font-weight: bold"></span><span style="color: #ffffff"></span>
<span style="color: #008800; font-style: italic; background-color: #0f140f">/* Wait for data to be received */</span> 
  <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(</span> <span style="color: #ffffff">!(UCSR0A</span> <span style="color: #ffffff">&amp;</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span><span style="color: #ffffff">&lt;&lt;RXC0)))</span><span style="color: #ffffff"></span><span style="color: #ffffff"></span><span style="color: #ffffff"></span><span style="color: #0086f7; font-weight: bold"></span><span style="color: #ffffff"></span><span style="color: #ffffff">;</span>
    
	
<span style="color: #008800; font-style: italic; background-color: #0f140f">/* Get and return received data from buffer */</span>
<span style="color: #fb660a; font-weight: bold">return</span> <span style="color: #ffffff">UDR0;</span>
	
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Transmit a string</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putstring</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">*</span> <span style="color: #ffffff">s)</span>
<span style="color: #ffffff">{</span>
    <span style="color: #008800; font-style: italic; background-color: #0f140f">// transmit character until NULL is reached</span>
    <span style="color: #fb660a; font-weight: bold">while</span><span style="color: #ffffff">(*s</span> <span style="color: #ffffff">&gt;</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">uart_putchar(*s++);</span>
<span style="color: #ffffff">}</span>
</pre></div>


		  






		<p></p>
        <p><a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/www.tinkercad.com">TinkerCad</a> implementation of the program:</p>
        <p><a href="https://www.tinkercad.com/things/4mpGeci84Mj">https://www.tinkercad.com/things/4mpGeci84Mj</a></p>
        <p>&nbsp;</p>
        <p>This program uses a polling approach to detect click events on the left switch .</p>

			<ul><li>Click-detection is done in the <code>process</code> function. The logic is very simple:
				<ul><li>If the left switch is closed, wait for it to become open, and then register a <em>click</em>.</li>
<li>Waiting with a loop in this way is called <em>busy waiting</em> – the CPU repeatedly executes the test in the while loop until the condition becomes false, at which point the program can move on.</li>
<li>Busy-waiting is avoided wherever possible because it locks the CPU up doing nothing, and because it may result in unpredictable delays.</li>
</ul></li>
<li>Bouncing happens on a very short timescale relative to the physical act of pressing and releasing the switch, so it is quite a challenge to demonstrate on purpose.
				<ul><li>If we introduce any significant delay, the effect is obscured.</li>
<li>To make the effect visible, this program performs absolutely minimal processing.</li>
<li>When a left button-click is detected, a counter increments silently.</li>
<li>To view the current value of the counter, push the right switch (it also send this value via uart).</li>
<li>Try multiple clicks on the left button and then display them by pressing right switch. Do the clicks and display values match?</li>
		</ul>
</li>
</ul>
		</div> 
		
	
    
		<h3><a name="debounce_soln_1">Delay-based de-bouncing (which is not very good)</a></h3>
		<div class="subsection">
			
	
    
		<h3><a name="dbs1_idea">Idea</a></h3>
		<div class="subsection">
				<p>About the simplest work-around is to try to take advantage of the short duration of the transient behaviour.</p>

				<ul><li>This click-detection algorithm is almost identical to the polling algorithm above.</li>
<li>We introduce a short delay just after the button-press is detected, but before the busy-wait that detects the button-release.</li>
<li>The hope is that the contact has closed properly by the time we enter the wait loop.</li>
</ul>
		  </div>
			
	
    
		<h3><a name="dbs1_impl">Implementation</a></h3>
		<div class="subsection">
				<p>Simple delay-based de-bouncing is demonstrated in <code>example2.c, DelayDebounceDemo</code>:
</p>
		  <pre style="line-height: 1.2; background: #0f140f; color: #BDAE9D; overflow-x: scroll; font-family: monospace; max-width: 100%;"><span class="sc2"></span><span class="sc10"><span style="color: #ff0007; font-weight: bold; font-style: italic; background-color: #0f140f">#define F_CPU (16000000UL)</span>

</span><span style="line-height: 1; background: #0f140f; color: #BDAE9D; font-family: monospace; max-width: 100%;"><span style="color: #ff0007; font-weight: bold; font-style: italic; background-color: #0f140f">#include &lt;avr/io.h&gt;</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">/*</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *  Setting data directions in a data direction register (DDR)</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *  Setting, clearing, and reading bits in registers.</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *	reg is the name of a register; pin is the index (0..7)</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *  of the bit to set, clear or read.</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *  (WRITE_BIT is a combination of CLEAR_BIT &amp; SET_BIT)</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> */</span>

<span style="color: #ff0007;font-weight: bold;">
#define SET_BIT(reg, pin)		    (reg) |= (1 &lt;&lt; (pin))
#define CLEAR_BIT(reg, pin)		  (reg) &amp;= ~(1 &lt;&lt; (pin))
#define WRITE_BIT(reg, pin, value)   (reg) = (((reg) &amp; ~(1 &lt;&lt; (pin))) | ((value) &lt;&lt; (pin)))
#define BIT_VALUE(reg, pin)		  (((reg) &gt;&gt; (pin)) &amp; 1)
#define BIT_IS_SET(reg, pin)	     (BIT_VALUE((reg),(pin))==1)
</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">//Functions declaration</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">setup</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">);
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">process</span>(<span style="color: #cdcaa9; font-weight: bold">void</span>);<span style="color: #cdcaa9; font-weight: bold">
void</span> <span style="color: #ff0086; font-weight: bold">uart_init</span>(<span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">int</span> ubrr)</span><span style="color: #ffffff"></span>;
<span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ff0086; font-weight: bold">uart_getchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span>;<span style="color: #ffffff"></span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">data)</span>;<span style="color: #ffffff"></span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putstring</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">*</span> <span style="color: #ffffff">s)</span>;


<span style="color: #008800; font-style: italic; background-color: #0f140f">//uart definitions</span>
<span style="color: #ff0007; font-weight: bold; font-style: italic; background-color: #0f140f">#define BAUD (9600)
#define MYUBRR (F_CPU/16/BAUD-1</span>)

<span style="color: #008800; font-style: italic; background-color: #0f140f">//delay using for debouncing</span>
<span style="color: #ff0007; font-weight: bold">#define DEBOUNCE_MS (50)</span>


<span style="color: #008800; font-style: italic; background-color: #0f140f">//to store button press count </span>
<span style="color: #cdcaa9; font-weight: bold">uint16_t</span> <span style="color: #ffffff">counter</span> <span style="color: #ffffff">=</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">;</span>
 

<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">setup</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
	
    <span style="color: #008800; font-style: italic; background-color: #0f140f">//init uart</span>
	<span style="color: #ffffff">uart_init(MYUBRR);</span>

	<span style="color: #008800; font-style: italic; background-color: #0f140f">// Enable B5 as output, led on B5</span>
	<span style="color: #ffffff">SET_BIT(DDRB,</span> <span style="color: #0086f7; font-weight: bold">5</span><span style="color: #ffffff">);</span>
    <span style="color: #ffffff"></span><span style="color: #0086f7; font-weight: bold"></span><span style="color: #ffffff"></span>
  
   <span style="color: #008800; font-style: italic; background-color: #0f140f">   // Enable D6 and D7 as inputs</span>
   <span style="color: #ffffff">    CLEAR_BIT(DDRD,</span><span style="color: #0086f7; font-weight: bold">6</span><span style="color: #ffffff">);</span>
    <span style="color: #ffffff">   CLEAR_BIT(DDRD,</span><span style="color: #0086f7; font-weight: bold">7</span><span style="color: #ffffff">);</span>

<span style="color: #ffffff">}</span>

<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">process</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
  
   <span style="color: #008800; font-style: italic; background-color: #0f140f">//define a buffer to be sent</span>
    <span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">temp_buf[</span><span style="color: #0086f7; font-weight: bold">64</span><span style="color: #ffffff">];</span>
  
  <span style="color: #ffffff">  snprintf(</span> <span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">*)temp_buf,</span> <span style="color: #fb660a; font-weight: bold">sizeof</span><span style="color: #ffffff">(temp_buf),</span> <span style="color: #0086d2">"%d\n"</span><span style="color: #ffffff">,</span> <span style="color: #ffffff">counter</span> <span style="color: #ffffff">);</span>
  
  
  <span style="color: #008800; font-style: italic; background-color: #0f140f">//detect pressed switch on D7</span>
  <span style="color: #fb660a; font-weight: bold">if</span> <span style="color: #ffffff">(BIT_IS_SET(PIND,</span><span style="color: #0086f7; font-weight: bold">7</span><span style="color: #ffffff">)){</span>
    
   <span class="sc11">_delay_ms(</span><span class="sc4">DEBOUNCE_MS</span><span class="sc11">);</span>

    <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(</span> <span style="color: #ffffff">BIT_IS_SET(PIND,</span> <span style="color: #0086f7; font-weight: bold">7</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
			<span style="color: #008800; font-style: italic; background-color: #0f140f">// Block until switch released.</span>
	<span style="color: #ffffff">}</span>
   
   <span style="color: #008800; font-style: italic; background-color: #0f140f">//increment counter</span>
	<span style="color: #ffffff">counter++;</span>
    
  <span style="color: #ffffff">}</span>
  
    <span style="color: #008800; font-style: italic; background-color: #0f140f">//detect presed switch on D6</span>
  <span style="color: #fb660a; font-weight: bold">if</span> <span style="color: #ffffff">(BIT_IS_SET(PIND,</span><span style="color: #0086f7; font-weight: bold">6</span><span style="color: #ffffff">)){</span>
   
   <span style="color: #008800; font-style: italic; background-color: #0f140f">//send serial data</span>
	<span style="color: #ffffff">uart_putstring(temp_buf);</span>
    
    <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(</span> <span style="color: #ffffff">BIT_IS_SET(PIND,</span> <span style="color: #0086f7; font-weight: bold">6</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
			<span style="color: #008800; font-style: italic; background-color: #0f140f">// Block until switch released.</span>
		<span style="color: #ffffff">}</span>
    
    <span style="color: #ffffff">}</span>
  
   <span style="color: #008800; font-style: italic; background-color: #0f140f">//flash LED every time increments of 5 occur</span>
    <span style="color: #fb660a; font-weight: bold">if</span><span style="color: #ffffff">(counter%</span><span style="color: #0086f7; font-weight: bold">5</span> <span style="color: #ffffff">==</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">)</span>
      <span style="color: #ffffff">PORTB^=(</span><span style="color: #0086f7; font-weight: bold">1</span><span style="color: #ffffff">&lt;&lt;PINB5);</span>
  
  
<span style="color: #ffffff">}</span>

<span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ff0086; font-weight: bold">main</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
	<span style="color: #ffffff">setup();</span>

	<span style="color: #fb660a; font-weight: bold">for</span> <span style="color: #ffffff">(</span> <span style="color: #ffffff">;;</span> <span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
		<span style="color: #ffffff">process();</span>
		<span style="color: #ffffff"></span><span style="color: #0086f7; font-weight: bold"></span><span style="color: #ffffff"></span>
	<span style="color: #ffffff">}</span>
<span style="color: #ffffff">}</span>




<span style="color: #008800; font-style: italic; background-color: #0f140f">/*  ****** serial definitions ************ */</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Initialize the UART</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_init</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">ubrr)</span> <span style="color: #ffffff">{</span>
	
	<span style="color: #ffffff">UBRR0H</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">)(ubrr&gt;&gt;</span><span style="color: #0086f7; font-weight: bold">8</span><span style="color: #ffffff">);</span>
    <span style="color: #ffffff">UBRR0L</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">)(ubrr);</span>
	<span style="color: #ffffff">UCSR0B</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span> <span style="color: #ffffff">&lt;&lt;</span> <span style="color: #ffffff">RXEN0)</span> <span style="color: #ffffff">|</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span> <span style="color: #ffffff">&lt;&lt;</span> <span style="color: #ffffff">TXEN0);</span>
	<span style="color: #ffffff">UCSR0C</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff"></span><span style="color: #0086f7; font-weight: bold"></span><span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">3</span><span style="color: #ffffff"> &lt;&lt; UCSZ00);</span>
	
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Transmit a data</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">data)</span> <span style="color: #ffffff">{</span>
	
    <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(!(</span> <span style="color: #ffffff">UCSR0A</span> <span style="color: #ffffff">&amp;</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span><span style="color: #ffffff">&lt;&lt;UDRE0)));</span> <span style="color: #008800; font-style: italic; background-color: #0f140f">/* Wait for empty transmit buffer*/</span>
    
  	<span style="color: #ffffff">UDR0</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">data;</span>            <span style="color: #008800; font-style: italic; background-color: #0f140f">/* Put data into buffer, sends the data */</span>
         	
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Receive data</span>
<span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ff0086; font-weight: bold">uart_getchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
<span style="color: #cdcaa9; font-weight: bold"></span><span style="color: #ffffff"></span><span style="color: #0086f7; font-weight: bold"></span><span style="color: #ffffff"></span>
<span style="color: #008800; font-style: italic; background-color: #0f140f">/* Wait for data to be received */</span> 
  <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(</span> <span style="color: #ffffff">!(UCSR0A</span> <span style="color: #ffffff">&amp;</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span><span style="color: #ffffff">&lt;&lt;RXC0))</span><span style="color: #ffffff"></span><span style="color: #ffffff"></span><span style="color: #ffffff"></span><span style="color: #0086f7; font-weight: bold"></span><span style="color: #ffffff"></span><span style="color: #ffffff">);</span>
    
	
<span style="color: #008800; font-style: italic; background-color: #0f140f">/* Get and return received data from buffer */</span>
<span style="color: #fb660a; font-weight: bold">return</span> <span style="color: #ffffff">UDR0;</span>
	
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Transmit a string</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putstring</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">*</span> <span style="color: #ffffff">s)</span>
<span style="color: #ffffff">{</span>
    <span style="color: #008800; font-style: italic; background-color: #0f140f">// transmit character until NULL is reached</span>
    <span style="color: #fb660a; font-weight: bold">while</span><span style="color: #ffffff">(*s</span> <span style="color: #ffffff">&gt;</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">uart_putchar(*s++);</span>
<span style="color: #ffffff">}</span>
</span><span class="sc2"></span></pre>
		  <p><a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/www.tinkercad.com">TinkerCad</a> implementation of the program:</p>
		  <p><a href="https://www.tinkercad.com/things/g78AzAs2sgJ">https://www.tinkercad.com/things/g78AzAs2sgJ</a></p>
		  <p>&nbsp;</p>
		</div>
			
	
    
		<h3><a name="dbs1_disc">Pros and Cons</a></h3>
		<div class="subsection">
				<p>Introducing a delay between detection of button-press and button-release “kind of” works.
					But it has some problems.</p>

				<ul><li>If the delay is too short, it just doesn’t work.</li>
<li>If the delay is too long, then the user may click faster than we can detect.</li>
<li>It is still unreliable because it still depends heavily on how fast the user do button-presses.</li>
<li>Regardless of the delay duration, synchronous click detection in this way is a bad idea.
					<ul><li>When we block the main event loop, everything stops until the click is detected.</li>
</ul></li>
</ul>
		  </div>
		</div> 

		
	
    
		<h3><a name="debounce_soln_2">Non-blocking de-bouncing (which is much better but not quite ideal)</a></h3>
		<div class="subsection">
			
	
    
		<h3><a name="dbs1_idea">Idea</a></h3>
		<div class="subsection">
		  <p>Both algorithms above rely on a two-phase procedure to detect a click:
					</p><ol>
<li>Detect that the switch is pressed.</li>
<li>Wait for the switch to be released.</li>
		  </ol>
		  <p>The busy wait is the main problem: the event loop stalls while we wait for the switch to be released. In the present section we examine an elegant non-blocking solution.</p>

				<ul><li>This algorithm hinges on the idea that at any given time the switch may be undergoing rapid on/off transitions due to bouncing, but that eventually the switch will settle to a stable configuration, at which point the button is either <em>definitely pressed</em> or <em>definitely not pressed</em>.
					<ul><li>Initially, we have no opinion as to the configuration.</li>
<li>As time passes we accumulate a log of evidence which sways between the two options: <em>definitely pressed</em> or <em>definitely not pressed</em>.</li>
<li>If enough evidence accumulates one way or the other, we accept the option.</li>
<li>We then start again.</li>
</ul></li>
<li>To decide if the button is in a stable configuration, we repeatedly (at high frequency) sample the button state.
					<ul><li>Every time we see the switch is closed, our opinion moves toward the conclusion that the button <em>may be</em> definitely pressed.</li>
<li>If we see the switch closed many times without ever seeing it open, we conclude that the button <em>is</em> definitely pressed.</li>
<li>Every time we see the switch open, we conclude that the button cannot possibly be definitely pressed, and our opinion moves toward the opposite conclusion, namely that the button <em>may not be</em> definitely pressed.</li>
<li>If we see the switch open many times without ever seeing it closed, we conclude that the button <em>is not</em> definitely pressed.</li>
</ul></li>
</ul>
		  </div>
			
	
    
		<h3><a name="dbs1_impl">Implementation</a></h3>
		<div class="subsection">
				<p>An implementation of this algorithm is provided in <code>example3.c, NonblockingDebounceDemo</code>:
</p>
		  <pre style="line-height: 1.2; background: #0f140f; color: #BDAE9D; overflow-x: scroll; font-family: monospace; max-width: 100%;"><span class="sc2"><span class="sc16"></span>
<span style="color: #ff0007; font-weight: bold; font-style: italic; background-color: #0f140f">#define F_CPU (16000000UL)</span>

<span style="line-height: 1; background: #0f140f; color: #BDAE9D; font-family: monospace; max-width: 100%;"><span style="color: #ff0007; font-weight: bold; font-style: italic; background-color: #0f140f">#include &lt;avr/io.h&gt;</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">/*</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *  Setting data directions in a data direction register (DDR)</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *  Setting, clearing, and reading bits in registers.</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *	reg is the name of a register; pin is the index (0..7)</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *  of the bit to set, clear or read.</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *  (WRITE_BIT is a combination of CLEAR_BIT &amp; SET_BIT)</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> */</span>

<span style="color: #ff0007;font-weight: bold;">
#define SET_BIT(reg, pin)		    (reg) |= (1 &lt;&lt; (pin))
#define CLEAR_BIT(reg, pin)		  (reg) &amp;= ~(1 &lt;&lt; (pin))
#define WRITE_BIT(reg, pin, value)   (reg) = (((reg) &amp; ~(1 &lt;&lt; (pin))) | ((value) &lt;&lt; (pin)))
#define BIT_VALUE(reg, pin)		  (((reg) &gt;&gt; (pin)) &amp; 1)
#define BIT_IS_SET(reg, pin)	     (BIT_VALUE((reg),(pin))==1)
</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">//Functions declaration</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">setup</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">);
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">process</span>(<span style="color: #cdcaa9; font-weight: bold">void</span>);<span style="color: #cdcaa9; font-weight: bold">
void</span> <span style="color: #ff0086; font-weight: bold">uart_init</span>(<span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">int</span> ubrr)</span><span style="color: #ffffff"></span>;
<span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ff0086; font-weight: bold">uart_getchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span>;<span style="color: #ffffff"></span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">data)</span>;<span style="color: #ffffff"></span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putstring</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">*</span> <span style="color: #ffffff">s)</span>;


<span style="color: #008800; font-style: italic; background-color: #0f140f">//uart definitions</span>
<span style="color: #ff0007; font-weight: bold; font-style: italic; background-color: #0f140f">#define BAUD (9600)
#define MYUBRR (F_CPU/16/BAUD-1)</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"></span>
<span style="color: #008800; font-style: italic; background-color: #0f140f">//threshold used for debouncing </span>
<span style="color: #ff0007; font-weight: bold">#define THRESHOLD (1000)</span>
</span></span><span style="line-height: 1; background: #0f140f; color: #BDAE9D; font-family: monospace; max-width: 100%;"><span style="color: #008800; font-weight: bold">
// State machine for button pressed </span>
<span class="sc11">bool pressed = </span><span class="sc2">false</span>;
<span class="sc11">uint16_t closed_num =</span> <span class="sc2">0</span>;
<span class="sc11">uint16_t open_num =</span> <span class="sc2">0</span>;
</span><span class="sc2"><span style="line-height: 1; background: #0f140f; color: #BDAE9D; font-family: monospace; max-width: 100%;"><span style="color: #cdcaa9; font-weight: bold">uint16_t</span> <span style="color: #ffffff">counter</span> <span style="color: #ffffff">=</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">;</span>

<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">setup</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
	
    <span style="color: #008800; font-style: italic; background-color: #0f140f">// initialise uart</span>
      <span style="color: #ffffff">uart_init(MYUBRR);</span>

	<span style="color: #008800; font-style: italic; background-color: #0f140f">// Enable B5 as output, led on B5</span>
	<span style="color: #ffffff">SET_BIT(DDRB,</span> <span style="color: #0086f7; font-weight: bold">5</span><span style="color: #ffffff">);</span>
    <span style="color: #008800; font-style: italic; background-color: #0f140f">   // Enable D6 and D7 as inputs</span>
   <span style="color: #ffffff">    CLEAR_BIT(DDRD,</span><span style="color: #0086f7; font-weight: bold">6</span><span style="color: #ffffff">);</span>
    <span style="color: #ffffff">   CLEAR_BIT(DDRD,</span><span style="color: #0086f7; font-weight: bold">7</span><span style="color: #ffffff">);</span>

<span style="color: #ffffff">}</span>

</span></span>
<span class="sc11">
bool </span><span class="sc4"><strong>left_button_clicked</strong></span><span class="sc11">(void){
  
  bool was_pressed = pressed;
  
  </span><span class="sc16">if</span><span class="sc11"> ( BIT_IS_SET(PIND, </span><span class="sc2">7</span><span class="sc11">) ) {
		closed_num++;
		open_num = </span><span class="sc2">0</span><span class="sc11">;

		</span><span class="sc16">if</span><span class="sc11"> ( closed_num  &gt; THRESHOLD ) {
			if ( !pressed ) {
				closed_num = </span><span class="sc2">0</span><span class="sc11">;
			}

			pressed = true;
		}
	}
	</span><span class="sc16">else</span><span class="sc11"> {
		open_num++;
		closed_num = </span><span class="sc2">0</span><span class="sc11">;

		</span><span class="sc16">if</span><span class="sc11"> ( open_num &gt; THRESHOLD ) {
			</span><span class="sc16">if</span><span class="sc11"> ( pressed ) {
				open_num = </span><span class="sc2">0</span><span class="sc11">;
			}

			pressed = </span><span class="sc2">false</span><span class="sc11">;
		}
	}

	</span><span class="sc16">return</span><span class="sc11"> was_pressed &amp;&amp; !pressed;
 
  
}</span>



<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">process</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
  
   <span style="color: #008800; font-style: italic; background-color: #0f140f">//define a buffer sent</span>
    <span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">temp_buf[</span><span style="color: #0086f7; font-weight: bold">64</span><span style="color: #ffffff">];</span>
  
  <span style="color: #ffffff">  snprintf(</span> <span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">*)temp_buf,</span> <span style="color: #fb660a; font-weight: bold">sizeof</span><span style="color: #ffffff">(temp_buf),</span> <span style="color: #0086d2">"%d\n"</span><span style="color: #ffffff">,</span> <span style="color: #ffffff">counter</span> <span style="color: #ffffff">);</span>
  
  
  <span style="color: #008800; font-style: italic; background-color: #0f140f">//detect pressed switch on D7</span>
  <span style="color: #fb660a; font-weight: bold">if</span> <span style="color: #ffffff">(left_button_clicked() </span><span style="color: #ffffff">){</span>
   
   <span style="color: #008800; font-style: italic; background-color: #0f140f">//increment count</span>
	<span style="color: #ffffff">counter++;</span>
    
  <span style="color: #ffffff">}</span>
  
    <span style="color: #008800; font-style: italic; background-color: #0f140f">//detect pressed switch on D6</span>
  <span style="color: #fb660a; font-weight: bold">if</span> <span style="color: #ffffff">(BIT_IS_SET(PIND,</span><span style="color: #0086f7; font-weight: bold">6</span><span style="color: #ffffff">)){</span>
   
   <span style="color: #008800; font-style: italic; background-color: #0f140f">//send serial data</span>
	<span style="color: #ffffff">uart_putstring(temp_buf);</span>
    
    <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(</span> <span style="color: #ffffff">BIT_IS_SET(PIND,</span> <span style="color: #0086f7; font-weight: bold">6</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
    <span style="color: #008800; font-style: italic; background-color: #0f140f">// Block until switch released.</span>
	<span style="color: #ffffff">}</span>
    
  <span style="color: #ffffff">}</span>
  
   <span style="color: #008800; font-style: italic; background-color: #0f140f">//flash LED every time increments of 5 occur</span>
    <span style="color: #fb660a; font-weight: bold">if</span><span style="color: #ffffff">(counter%</span><span style="color: #0086f7; font-weight: bold">5</span> <span style="color: #ffffff">==</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">)</span>
    <span style="color: #ffffff">PORTB^=(</span><span style="color: #0086f7; font-weight: bold">1</span><span style="color: #ffffff">&lt;&lt;PINB5);</span>
  
  
<span style="color: #ffffff">}</span>

<span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ff0086; font-weight: bold">main</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
	<span style="color: #ffffff">setup();</span>

	<span style="color: #fb660a; font-weight: bold">for</span> <span style="color: #ffffff">(</span> <span style="color: #ffffff">;;</span> <span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
	<span style="color: #ffffff">   process();</span><span style="color: #ffffff"></span><span style="color: #0086f7; font-weight: bold"></span><span style="color: #ffffff"></span>
	<span style="color: #ffffff">}</span>
<span style="color: #ffffff">}</span>




<span style="color: #008800; font-style: italic; background-color: #0f140f">/*  ****** serial definitions ************ */</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Initialize the UART</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_init</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">ubrr)</span> <span style="color: #ffffff">{</span>
	
	<span style="color: #ffffff">UBRR0H</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">)(ubrr&gt;&gt;</span><span style="color: #0086f7; font-weight: bold">8</span><span style="color: #ffffff">);</span>
    <span style="color: #ffffff">UBRR0L</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">)(ubrr);</span>
	<span style="color: #ffffff">UCSR0B</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span> <span style="color: #ffffff">&lt;&lt;</span> <span style="color: #ffffff">RXEN0)</span> <span style="color: #ffffff">|</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span> <span style="color: #ffffff">&lt;&lt;</span> <span style="color: #ffffff">TXEN0);</span>
	<span style="color: #ffffff">UCSR0C</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff"></span><span style="color: #0086f7; font-weight: bold"></span><span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">3 </span><span style="color: #ffffff">&lt;&lt; UCSZ00);</span>
	
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Transmit a data</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">data)</span> <span style="color: #ffffff">{</span>
	
    <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(!(</span> <span style="color: #ffffff">UCSR0A</span> <span style="color: #ffffff">&amp;</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span><span style="color: #ffffff">&lt;&lt;UDRE0)));</span> <span style="color: #008800; font-style: italic; background-color: #0f140f">/* Wait for empty transmit buffer*/</span>
    
  	<span style="color: #ffffff">UDR0</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">data;</span>            <span style="color: #008800; font-style: italic; background-color: #0f140f">/* Put data into buffer, sends the data */</span>
         	
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Receive data</span>
<span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ff0086; font-weight: bold">uart_getchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
<span style="color: #cdcaa9; font-weight: bold"></span><span style="color: #ffffff"></span><span style="color: #0086f7; font-weight: bold"></span><span style="color: #ffffff"></span>
<span style="color: #008800; font-style: italic; background-color: #0f140f">/* Wait for data to be received */</span> 
  <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(</span> <span style="color: #ffffff">!(UCSR0A</span> <span style="color: #ffffff">&amp;</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span><span style="color: #ffffff">&lt;&lt;RXC0))</span><span style="color: #ffffff"></span><span style="color: #ffffff"></span><span style="color: #ffffff"></span><span style="color: #0086f7; font-weight: bold"></span><span style="color: #ffffff"></span><span style="color: #ffffff">);</span>
    
	
<span style="color: #008800; font-style: italic; background-color: #0f140f">/* Get and return received data from buffer */</span>
<span style="color: #fb660a; font-weight: bold">return</span> <span style="color: #ffffff">UDR0;</span>
	
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Transmit a string</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putstring</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">*</span> <span style="color: #ffffff">s)</span>
<span style="color: #ffffff">{</span>
    <span style="color: #008800; font-style: italic; background-color: #0f140f">// transmit character until NULL is reached</span>
    <span style="color: #fb660a; font-weight: bold">while</span><span style="color: #ffffff">(*s</span> <span style="color: #ffffff">&gt;</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">uart_putchar(*s++);</span>
<span style="color: #ffffff">}</span>

<span class="sc2"></span>
</pre>
		<p></p>
		<p><a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/www.tinkercad.com">TinkerCad</a> implementation of the program:</p>
		<p><a href="https://www.tinkercad.com/things/a2LDCDOPByq">https://www.tinkercad.com/things/a2LDCDOPByq</a></p>
		<p>&nbsp;</p>
		<p>The algorithm is implemented in the <code>left_button_clicked</code> function.</p>

				<ul><li>We use a boolean variable called <code>pressed</code> to record whether the button is <em>definitely pressed</em> or <em>definitely not pressed</em>.</li>
<li>Along with <code>pressed</code>, we keep a pair of counters.
					<ul><li><code>open_num</code> is the number of consecutive times the switch has been observed to be open.</li>
<li><code>closed_num</code> is the number of consecutive times the switch has been observed to be closed.</li>
</ul></li>
<li>Every time we poll the switch state, we update one or more of these three variables.
					<ul><li>If the switch is closed, we increment <code>closed_num</code> and restore <code>open_num</code> to 0. If <code>open_num</code> passes a threshold (in this case, <code>1000</code>), we assign <code>pressed&nbsp;=&nbsp;true</code> –; <em>definitely pressed</em>.</li>
<li>If the switch is open, we increment <code>open_num</code> and restore <code>closed_num</code> to 0. If <code>closed_num</code> passes the threshold, we assign <code>pressed&nbsp;=&nbsp;false</code> –; not <em>definitely pressed</em>.</li>
</ul></li>
<li>Each time we settle on a switch state, we reset the counters and the accumulation process starts again.</li>
</ul>
		  </div>
			
	
    
		<h3><a name="dbs1_disc">Pros and Cons</a></h3>
		<div class="subsection">
				<p>This non-blocking de-bounce method is pretty good.</p>

				<ul><li>The boolean <code>pressed</code> variable is a reliable indication of the true state of the button.</li>
<li>Click tests based on transitions between <code>pressed&nbsp;==&nbsp;true</code> and <code>pressed&nbsp;==&nbsp;false</code> are very reliable.</li>
</ul>
				<p>Perceived problems:</p>

				<ul><li>The decision depends on <code>THRESHOLD</code>, which must be just right.
					<ul><li>The correct value will depend not only on the microcontroller clock speed, but also on the time between calls to <code>left_button_clicked</code>.</li>
<li>Performance may not be consistent due to factors elsewhere in the program.</li>
<li><em>The algorithm polls the switch in the main event loop, which means we can never guarantee reliable performance.</em></li>
</ul></li>
</ul>
		  </div>
		</div> 
		
		
	
    
		<h3><a name="debounce_conclusion">De-bouncing conclusion</a></h3>
		<div class="subsection">
			<ul><li>We have demonstrated switch bounce, and examined a two ways to address the problem.</li>
<li>A non-blocking algorithm has been developed which is very good, but still relies on polling.</li>
<li>To perfect the algorithm, we need a way to sample the physical state of the switch at a fairly high and constant frequency. <strong>Hint: Timers and Interrupts</strong>.</li>
</ul>
		</div>
	
		<hr>
	
	

    
		<h2><a name="timers">ATMega328P Timers</a></h2>
		<div class="section">
		
	
    
		<h3><a name="timer_intro">Timer Introduction</a></h3>
		<div class="subsection">
			<p>A timer is a semi-autonomous subsystem which runs alongside the CPU.</p>
			<ul>
<li><em>Refer: ATMega328P Datasheet, Chapters 15–17.</em></li>
<li>The timer executes a very simple program which listens to a clock signal.
				<ul>
<li>By default, ATMega328P timers use use the built-in system clock which runs at 16,000,000 cycles per second (16MHz).</li>
<li>Clock signal can also come from external source.</li>
<li>After a fixed number of clock cycles, the timer updates a counter which occupies one or two 8-bit register.</li>
<li>The counter updates continuously as long as the timer is enabled.</li>
<li>When the counter reaches its maximum value, it wraps back to zero.
					<ul><li>The timer can also trigger an interrupt when the counter overflows.</li>
<li>This is covered in the next section.</li>
</ul></li>
<li>In addition to timekeeping, timers can be used to generate waveforms which in turn control external devices.
					<ul><li>Removing processing load from CPU.</li>
<li>Pulse Width Modulation (PWM) will be covered in Topic 11.</li>
</ul></li>
</ul></li>
</ul>
			<p>ATMega328P has three timers:</p>

			<ul>
<li>Timer 0: 8 bit timer (counter ranges from 0 to 255)</li>
<li>Timer 1: 16 bit timer (counter range from 0 to 65,535)</li>
<li>Timer 2: 8 bit timer (range from 0 to 255)</li>
</ul>
			<p>Each timer has a set of dedicated  registers.</p>

		</div>
		
	
    
		<h3><a name="timer0_registers">Timer0 registers (Datasheet, Section 15.9)</a></h3>
		<div class="subsection">
			<p>Each timer has a set of dedicated control and counter registers. Details are shown for Timer 0; you can look up the datasheet to find the corresponding registers for Timers 1 and 2.</p>

			<ul><li><code>TCCR0A</code> – Timer/Counter Control Register 0 A:
				<table cellspacing="0" border="1">
				<tbody><tr><td style="min-width:1in;">Bits</td><td style="min-width:1in;">7</td><td style="min-width:1in;">6</td><td style="min-width:1in;">5</td><td style="min-width:1in;">4</td><td style="min-width:1in;">3</td><td style="min-width:1in;">2</td><td style="min-width:1in;">1</td><td style="min-width:1in;">0</td></tr>
				<tr><td style="min-width:1in;">Name</td><td style="min-width:1in;"><code>COMOA1</code></td><td style="min-width:1in;"><code>COMOA0</code></td><td style="min-width:1in;"><code>COMOB1</code></td><td style="min-width:1in;"><code>COMOB0</code></td><td style="min-width:1in;">-</td><td style="min-width:1in;">-</td><td style="min-width:1in;"><code>WGM01</code></td><td style="min-width:1in;"><code>WGM00</code></td></tr>
				<tr><td style="min-width:1in;">Read/Write</td><td style="min-width:1in;">R/W</td><td style="min-width:1in;">R/W</td><td style="min-width:1in;">R/W</td><td style="min-width:1in;">R/W</td><td style="min-width:1in;">R</td><td style="min-width:1in;">R</td><td style="min-width:1in;">R/W</td><td style="min-width:1in;">R/W</td></tr>
				<tr><td style="min-width:1in;">initially</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td></tr>
				</tbody></table>
				<ul><li><code>COMOAx</code> = Compare Match Output A Mode: leave this at 0</li>
<li><code>COMOBx</code> = Compare Match Output B Mode: leave this at 0</li>
<li><code>WGM0x</code> = Waveform Generation  Mode: leave this at 0</li>
<li><b>TL;DR – For our current purposes either ignore, or assign 0, to this register</b></li>
</ul></li>
<li><code>TCCR0B</code> – Timer/Counter Control Register 0 B:
				<table cellspacing="0" border="1">
				<tbody><tr><td style="min-width:1in;">Bits</td><td style="min-width:1in;">7</td><td style="min-width:1in;">6</td><td style="min-width:1in;">5</td><td style="min-width:1in;">4</td><td style="min-width:1in;">3</td><td style="min-width:1in;">2</td><td style="min-width:1in;">1</td><td style="min-width:1in;">0</td></tr>
				<tr><td style="min-width:1in;">Name</td><td style="min-width:1in;"><code>FOC0A</code></td><td style="min-width:1in;"><code>FOC0B</code></td><td style="min-width:1in;">-</td><td style="min-width:1in;">-</td><td style="min-width:1in;"><code>WGM02</code></td><td style="min-width:1in;"><code>CS02</code></td><td style="min-width:1in;"><code>CS01</code></td><td style="min-width:1in;"><code>CS00</code></td></tr>
				<tr><td style="min-width:1in;">Read/Write</td><td style="min-width:1in;">W</td><td style="min-width:1in;">W</td><td style="min-width:1in;">R</td><td style="min-width:1in;">R</td><td style="min-width:1in;">R/W</td><td style="min-width:1in;">R/W</td><td style="min-width:1in;">R/W</td><td style="min-width:1in;">R/W</td></tr>
				<tr><td style="min-width:1in;">initially</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td></tr>
				</tbody></table>
				<ul><li><code>FOC0x</code> = Force output compare: leave these at 0.</li>
<li><code>WGM02</code> = Waveform Generation  Mode: leave this at 0.</li>
<li><code>CS02,CS01,CS00</code> = Clock Select.
					<br>
					Datasheet P 117, Table 15-9.
					<br>
					These bits taken together form a 3-bit number which tells the timer how frequently to update the counter.
					The system clock speed is <em>pre-scaled</em> by dividing by the designated factor for each Clock Select combination.
					<br>
					<em>Figures in this table assume that the CPU speed is set to 16MHz in the <code>setup</code> phase.</em>
					<br>
					Values are:
					<table cellspacing="0" border="1">
						<tbody><tr><td width="83"><code>CS02:0</code></td><td width="391">Counter updates…</td></tr>
						<tr><td><code>0b000</code></td><td>Never (Timer/Counter stopped)</td></tr>
						<tr><td><code>0b001</code></td>
						<td>Every clock cycle (No pre-scaling) == 16,000,000 ticks/sec</td></tr>
						<tr><td><code>0b010</code></td>
						<td>Every 8 clock cycles == 2,000,000 ticks/sec</td></tr>
						<tr><td><code>0b011</code></td>
						<td>Every 64 clock cycles == 250,000 ticks/sec</td></tr>
						<tr><td><code>0b100</code></td>
						<td>Every 256 clock cycles == 62,500 ticks/sec</td></tr>
						<tr><td><code>0b101</code></td>
						<td>Every 1024 clock cycles == 15,625 ticks/sec</td>
						</tr>
						<tr><td><code>0b110</code></td><td>External clock source on T0 pin. Clock on falling edge.</td></tr>
						<tr><td><code>0b111</code></td><td>External clock source on T0 pin. Clock on rising edge.</td></tr>
					</tbody></table>
					<ul><li>We will not be using CS02:0 == 6 or CS02:0 == 7.</li>
</ul></li>
</ul></li>
<li><code>TCNT0</code> – Timer/Counter Register 0: an 8-bit numeric value. <strong>Where the count is stored.</strong></li>
<li><code>OCR0A</code> – Output Compare Register 0 A: an 8-bit numeric value. We will not be using this.</li>
<li><code>OCR0B</code> – Output Compare Register 0 B: an 8-bit numeric value. We will not be using this.</li>
<li><code>TIMSK0</code> – Timer/Counter Interrupt Mask Register 0: 
				<table cellspacing="0" border="1">
				<tbody><tr><td style="min-width:1in;">Bits</td><td style="min-width:1in;">7</td><td style="min-width:1in;">6</td><td style="min-width:1in;">5</td><td style="min-width:1in;">4</td><td style="min-width:1in;">3</td><td style="min-width:1in;">2</td><td style="min-width:1in;">1</td><td style="min-width:1in;">0</td></tr>
				<tr><td style="min-width:1in;">Name</td><td style="min-width:1in;">-</td><td style="min-width:1in;">-</td><td style="min-width:1in;">-</td><td style="min-width:1in;">-</td><td style="min-width:1in;">-</td><td style="min-width:1in;"><code>OCIE0B</code></td><td style="min-width:1in;"><code>OCIE0A</code></td><td style="min-width:1in;"><code>TOIE0</code></td></tr>
				<tr><td style="min-width:1in;">Read/Write</td><td style="min-width:1in;">R</td><td style="min-width:1in;">R</td><td style="min-width:1in;">R</td><td style="min-width:1in;">R</td><td style="min-width:1in;">R</td><td style="min-width:1in;">R/W</td><td style="min-width:1in;">R/W</td><td style="min-width:1in;">R/W</td></tr>
				<tr><td style="min-width:1in;">initially</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td><td style="min-width:1in;">0</td></tr>
				</tbody></table>
				<ul><li><code>OCIE0B</code> = Force output compare: leave these at 0</li>
<li><code>OCIE0A</code> = Force output compare: leave these at 0</li>
<li><code>TOIE0</code> = Enable Timer Overflow Interrupt.</li>
</ul></li>
</ul>
		</div> 

		
	
    
		<h3><a name="timer0">Case study: Set Up and Read Time From Timer0</a></h3>
		<div class="subsection">
			<p>In the present section we set up Timer 0, and see how to read the value of the clock.</p>

			<ul><li>First, decide how fast we want the Timer/Counter register to update.</li>
<li>Timer 0 is an 8 bit timer, so the Timer/Counter register will overflow every 256 ticks.</li>
<li>We know the number of ticks per second from the datasheet, so we can calculate how long it will take for the timer to count from 0 to 255  (the overflow period) and how many times the counter will overflow per second (the overflow frequency).<br>Definition: Frequency = 1 / Period.
					<br>
					<em>Figures in this table assume that the CPU speed is set to 16MHz in the <code>setup</code> phase.</em>
				    <table cellspacing="0" border="1">
					<tbody><tr><td><code>CS02:0</code></td><td>Pre-scaler</td><td>Counter frequency</td><td>Overflow period = 256/freq</td><td>Overflow frequency</td></tr>
					<tr><td><code>0b000</code></td><td>0</td><td>0</td><td>n/a</td><td>n/a</td></tr>
					<tr><td><code>0b001</code></td><td>1</td>
					<td>16MHz</td>
					<td>0.000016s</td>
					<td>62.5kHz</td></tr>
					<tr><td><code>0b010</code></td><td>8</td>
					<td>2MHz</td>
					<td>0.000128s</td>
					<td>7.8125kHz</td></tr>
					<tr><td><code>0b011</code></td><td>64</td>
					<td>250kHz</td>
					<td>0.001024s</td>
					<td>976.56Hz</td></tr>
					<tr><td><code>0b100</code></td><td>256</td>
					<td>62.500kHz</td>
					<td>0.004096s</td>
					<td>244.14Hz</td></tr>
					<tr><td><code>0b101</code></td><td>1024</td>
					<td>15.625kHz</td>
					<td>0.016384s</td>
					<td>61.035Hz</td></tr>
				</tbody></table></li>
<li>Using the table, and balancing the update speed against our needs, we choose a pre-scaler.</li>
<li>To set up Timer 0 to overflow about 61 times per second, we choose <code>CS02:0&nbsp;==&nbsp;0b101&nbsp;==&nbsp;5</code>, which corresponds to a pre-scaler of 1024.</li>
<li>Starting the timer then consists of:
				<ul><li>Set <code>TCCR0A&nbsp;=&nbsp;0;</code></li>
<li>Set <code>TCCR0B&nbsp;=&nbsp;5;</code></li>
</ul></li>
<li>To read the timer, we access <code>TCNT0</code>.
				<ul><li>The value of the counter is a number of ticks.</li>
<li>To convert from ticks back to seconds, we multiply by the pre-scaler and divide by clock speed.</li>
<li><code>#define&nbsp;FREQ&nbsp;16000000.0</code><br>
					<code>#define&nbsp;PRESCALE&nbsp;1024.0</code><br>
					<code>double&nbsp;time&nbsp;=&nbsp;TCNT0&nbsp;*&nbsp;PRESCALE&nbsp;/&nbsp;FREQ;</code></li>
</ul></li>
</ul>
		  <p>This procedure is demonstrated in <code>example4.c, ReadTimer0</code>
		  </p>
<p style="margin-left: 0.5in;">
</p><pre style="line-height: 1.2; background: #0f140f; color: #BDAE9D; overflow-x: scroll; font-family: monospace; max-width: 100%;"><span class="sc2"></span>

<span class="sc10">#define F_CPU (16000000UL)</span>

<span class="sc10">
#include &lt;stdint.h&gt;
#include &lt;stdio.h&gt;
#include &lt;avr/io.h&gt; 
#include &lt;avr/interrupt.h&gt;
#include &lt;util/delay.h&gt;

<span style="line-height: 1; background: #0f140f; color: #BDAE9D; font-family: monospace; max-width: 100%;"><span style="color: #008800; font-style: italic; background-color: #0f140f">/*</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *  Setting data directions in a data direction register (DDR)</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *  Setting, clearing, and reading bits in registers.</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *	reg is the name of a register; pin is the index (0..7)</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *  of the bit to set, clear or read.</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> *  (WRITE_BIT is a combination of CLEAR_BIT &amp; SET_BIT)</span>
<span style="color: #008800; font-style: italic; background-color: #0f140f"> */</span>

<span style="color: #ff0007;font-weight: bold;">
#define SET_BIT(reg, pin)		    (reg) |= (1 &lt;&lt; (pin))
#define CLEAR_BIT(reg, pin)		  (reg) &amp;= ~(1 &lt;&lt; (pin))
#define WRITE_BIT(reg, pin, value)   (reg) = (((reg) &amp; ~(1 &lt;&lt; (pin))) | ((value) &lt;&lt; (pin)))
#define BIT_VALUE(reg, pin)		  (((reg) &gt;&gt; (pin)) &amp; 1)
#define BIT_IS_SET(reg, pin)	     (BIT_VALUE((reg),(pin))==1)
</span></span>

<span style="line-height: 1; background: #0f140f; color: #BDAE9D; font-family: monospace; max-width: 100%;"><span style="color: #008800; font-style: italic; background-color: #0f140f">//Functions declaration</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">setup</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">);
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">process</span>(<span style="color: #cdcaa9; font-weight: bold">void</span>);<span style="color: #cdcaa9; font-weight: bold">
void</span> <span style="color: #ff0086; font-weight: bold">uart_init</span>(<span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">int</span> ubrr)</span><span style="color: #ffffff"></span>;
<span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ff0086; font-weight: bold">uart_getchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span>;<span style="color: #ffffff"></span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">data)</span>;<span style="color: #ffffff"></span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putstring</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">*</span> <span style="color: #ffffff">s)</span>;</span><span style="background: #111111;"><span style="color: #cdcaa9; font-weight: bold">
void</span> <span style="color: #ff0086; font-weight: bold">ftoa</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">float</span> <span style="color: #ffffff">n,</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">*</span> <span style="color: #ffffff">res,</span> <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">afterpoint);
<span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ff0086; font-weight: bold">intToStr</span>(<span style="color: #cdcaa9; font-weight: bold">int</span> x, <span style="color: #cdcaa9; font-weight: bold">char</span> str[], <span style="color: #cdcaa9; font-weight: bold">int</span> d);
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">reverse</span>(<span style="color: #cdcaa9; font-weight: bold">char</span> * str, <span style="color: #cdcaa9; font-weight: bold">int</span> len);
</span></span></span><span style="line-height: 1; background: #0f140f; color: #BDAE9D; font-family: monospace; max-width: 100%;"><span style="color: #008800; font-style: italic; background-color: #0f140f">

//uart definitions</span>
<span style="color: #ff0007; font-weight: bold; font-style: italic; background-color: #0f140f">#define BAUD (9600)
#define MYUBRR (F_CPU/16/BAUD-1)</span></span>

<span class="sc10"></span><span class="sc10">
<span style="line-height: 1; background: #0f140f; color: #BDAE9D; font-family: monospace; max-width: 100%;"><span style="color: #008800; font-style: italic; background-color: #0f140f">//timer definitions</span>
<span style="color: #ff0007; font-weight: bold; font-style: italic; background-color: #0f140f">#define FREQ (16000000.0)
#define PRESCALE (1024.0)</span></span>
</span><span style="color: #008800"></span><br><span class="sc11">void</span> <span style="color: #ff0086">setup</span>(<span class="sc11">void</span>) {<span class="sc11"></span>


     <span style="line-height: 1; background: #0f140f; color: #BDAE9D; font-family: monospace; max-width: 100%;"><span style="color: #008800; font-style: italic; background-color: #0f140f">// initialise uart</span>
      <span style="color: #ffffff">uart_init(MYUBRR);</span></span>


	<span class="sc6" style="color: #008800">// Timer 0 in normal mode, with pre-scaler 1024 ==&gt; ~61Hz overflow.</span>
	<span class="sc11">TCCR0A</span> = <span class="sc4">0</span>;
	<span class="sc11">TCCR0B</span> = <span class="sc4">5</span>; 

	<span style="color: #008800">/*
	Alternatively:
		CLEAR_BIT(TCCR0B,WGM02);
		SET_BIT(TCCR0B,CS02);
		CLEAR_BIT(TCCR0B,CS01);
		SET_BIT(TCCR0B,CS00);
	*/</span>
}
<span class="sc9"></span><span class="sc11"></span><span class="sc4"></span>

<span class="sc11">void</span> <span style="color: #ff0086">process</span>(<span class="sc11">void</span>) {

	<span style="color: #cdcaa9; font-weight: bold"></span><span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">temp_buf[</span><span style="color: #0086f7; font-weight: bold">64</span><span style="color: #ffffff">];</span>
   <span class="sc11"> char *ch;</span>

	<span class="sc9">double</span> <span class="sc11">time</span> = (<span class="sc9">double</span>) <span class="sc11">TCNT0</span> * <span class="sc10">PRESCALE</span> / <span class="sc10">FREQ</span>;

<span style="line-height: 1.2; background: #0f140f; color: #BDAE9D; overflow-x: scroll; font-family: monospace; max-width: 100%;"><span style="color: #ffffff">    <span style="color: #008800">//convert float to a string</span> 
    ftoa(time, temp_buf, 4);</span></span>

	 <span style="color: #008800; font-style: italic; background-color: #0f140f">//send serial data</span>
	 <span style="color: #ffffff">uart_putstring((unsigned char *)temp_buf);</span>
     <span class="sc11">uart_putchar(</span><span class="sc4">'\n'</span><span class="sc11">);</span>
}

<span class="sc9">int</span> <span style="color: #ff0086">main</span>(<span class="sc11">void</span>) {
	<span class="sc11">setup</span>();

	<span class="sc5">for</span> ( ;; ) {
		<span class="sc11">process</span>();
       <span class="sc11">_delay_ms(</span><span class="sc4">500</span><span class="sc11">);</span>
	}
}



<span style="color: #008800; font-style: italic; background-color: #0f140f">/*  ****** auxiliary functions ************ */</span>
<div style="background: #111111;">
<span style="color: #008800; background-color: #0f140f">// Reverses a string 'str' of length 'len' </span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">reverse</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">*</span> <span style="color: #ffffff">str,</span> <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">len)</span> <span style="color: #ffffff">{</span>
  <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">i</span> <span style="color: #ffffff">=</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">,</span> <span style="color: #ffffff">j</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">len</span> <span style="color: #ffffff">-</span> <span style="color: #0086f7; font-weight: bold">1</span><span style="color: #ffffff">,</span> <span style="color: #ffffff">temp;</span>
  <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(i</span> <span style="color: #ffffff">&lt;</span> <span style="color: #ffffff">j)</span> <span style="color: #ffffff">{</span>
    <span style="color: #ffffff">temp</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">str[i];</span>
    <span style="color: #ffffff">str[i]</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">str[j];</span>
    <span style="color: #ffffff">str[j]</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">temp;</span>
    <span style="color: #ffffff">i++;</span>
    <span style="color: #ffffff">j--;</span>
  <span style="color: #ffffff">}</span>
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Converts a given integer x to string str[].  </span>
<span style="color: #008800; font-style: italic; background-color: #0f140f">// d is the number of digits required in the output.  </span>
<span style="color: #008800; font-style: italic; background-color: #0f140f">// If d is more than the number of digits in x,  </span>
<span style="color: #008800; font-style: italic; background-color: #0f140f">// then 0s are added at the beginning. </span>
<span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ff0086; font-weight: bold">intToStr</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">x,</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">str[],</span> <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">d)</span> <span style="color: #ffffff">{</span>
  <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">i</span> <span style="color: #ffffff">=</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">;</span>
  <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(x)</span> <span style="color: #ffffff">{</span>
    <span style="color: #ffffff">str[i++]</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(x</span> <span style="color: #ffffff">%</span> <span style="color: #0086f7; font-weight: bold">10</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">+</span> <span style="color: #0086d2">'0'</span><span style="color: #ffffff">;</span>
    <span style="color: #ffffff">x</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">x</span> <span style="color: #ffffff">/</span> <span style="color: #0086f7; font-weight: bold">10</span><span style="color: #ffffff">;</span>
  <span style="color: #ffffff">}</span>

  <span style="color: #008800; font-style: italic; background-color: #0f140f">// If number of digits required is more, then </span>
  <span style="color: #008800; font-style: italic; background-color: #0f140f">// add 0s at the beginning </span>
  <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(i</span> <span style="color: #ffffff">&lt;</span> <span style="color: #ffffff">d)</span>
    <span style="color: #ffffff">str[i++]</span> <span style="color: #ffffff">=</span> <span style="color: #0086d2">'0'</span><span style="color: #ffffff">;</span>

  <span style="color: #ffffff">reverse(str,</span> <span style="color: #ffffff">i);</span>
  <span style="color: #ffffff">str[i]</span> <span style="color: #ffffff">=</span> <span style="color: #0086d2">'\0'</span><span style="color: #ffffff">;</span>
  <span style="color: #fb660a; font-weight: bold">return</span> <span style="color: #ffffff">i;</span>
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Converts a floating-point/double number to a string. </span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">ftoa</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">float</span> <span style="color: #ffffff">n,</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">*</span> <span style="color: #ffffff">res,</span> <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">afterpoint)</span> <span style="color: #ffffff">{</span>
  <span style="color: #008800; font-style: italic; background-color: #0f140f">// Extract integer part </span>
  <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">ipart</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">int</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">n;</span>

  <span style="color: #008800; font-style: italic; background-color: #0f140f">// Extract floating part </span>
  <span style="color: #cdcaa9; font-weight: bold">float</span> <span style="color: #ffffff">fpart</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">n</span> <span style="color: #ffffff">-</span> <span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">float</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">ipart;</span>

  <span style="color: #008800; font-style: italic; background-color: #0f140f">// convert integer part to string </span>
  <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">i</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">intToStr(ipart,</span> <span style="color: #ffffff">res,</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">);</span>

  <span style="color: #008800; font-style: italic; background-color: #0f140f">// check for display option after point </span>
  <span style="color: #fb660a; font-weight: bold">if</span> <span style="color: #ffffff">(afterpoint</span> <span style="color: #ffffff">!=</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
    <span style="color: #ffffff">res[i]</span> <span style="color: #ffffff">=</span> <span style="color: #0086d2">'.'</span><span style="color: #ffffff">;</span> <span style="color: #008800; font-style: italic; background-color: #0f140f">// add dot </span>

    <span style="color: #008800; font-style: italic; background-color: #0f140f">// Get the value of fraction part upto given no. </span>
    <span style="color: #008800; font-style: italic; background-color: #0f140f">// of points after dot. The third parameter  </span>
    <span style="color: #008800; font-style: italic; background-color: #0f140f">// is needed to handle cases like 233.007 </span>
    <span style="color: #ffffff">fpart</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">fpart</span> <span style="color: #ffffff">*</span> <span style="color: #ffffff">pow(</span><span style="color: #0086f7; font-weight: bold">10</span><span style="color: #ffffff">,</span> <span style="color: #ffffff">afterpoint);</span>

    <span style="color: #ffffff">intToStr((</span><span style="color: #cdcaa9; font-weight: bold">int</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">fpart,</span> <span style="color: #ffffff">res</span> <span style="color: #ffffff">+</span> <span style="color: #ffffff">i</span> <span style="color: #ffffff">+</span> <span style="color: #0086f7; font-weight: bold">1</span><span style="color: #ffffff">,</span> <span style="color: #ffffff">afterpoint);</span>
  <span style="color: #ffffff">}</span>
<span style="color: #ffffff">}</span>
</div>











<span style="color: #008800; font-style: italic; background-color: #0f140f">/*  ****** serial definitions ************ */</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Initialize the UART</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_init</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">ubrr)</span> <span style="color: #ffffff">{</span>
	
	<span style="color: #ffffff">UBRR0H</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">)(ubrr&gt;&gt;</span><span style="color: #0086f7; font-weight: bold">8</span><span style="color: #ffffff">);</span>
    <span style="color: #ffffff">UBRR0L</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">)(ubrr);</span>
	<span style="color: #ffffff">UCSR0B</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span> <span style="color: #ffffff">&lt;&lt;</span> <span style="color: #ffffff">RXEN0)</span> <span style="color: #ffffff">|</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span> <span style="color: #ffffff">&lt;&lt;</span> <span style="color: #ffffff">TXEN0);</span>
	<span style="color: #ffffff">UCSR0C</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff"></span><span style="color: #0086f7; font-weight: bold"></span><span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">3</span><span style="color: #ffffff"> &lt;&lt; UCSZ00);</span>
	
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Transmit a data</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">data)</span> <span style="color: #ffffff">{</span>
	
    <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(!(</span> <span style="color: #ffffff">UCSR0A</span> <span style="color: #ffffff">&amp;</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span><span style="color: #ffffff">&lt;&lt;UDRE0)));</span> <span style="color: #008800; font-style: italic; background-color: #0f140f">/* Wait for empty transmit buffer*/</span>
    
  	<span style="color: #ffffff">UDR0</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">data;</span>            <span style="color: #008800; font-style: italic; background-color: #0f140f">/* Put data into buffer, sends the data */</span>
         	
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Receive data</span>
<span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ff0086; font-weight: bold">uart_getchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
<span style="color: #cdcaa9; font-weight: bold"></span><span style="color: #ffffff"></span><span style="color: #0086f7; font-weight: bold"></span><span style="color: #ffffff"></span>
<span style="color: #008800; font-style: italic; background-color: #0f140f">/* Wait for data to be received */</span> 
  <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(</span> <span style="color: #ffffff">!(UCSR0A</span> <span style="color: #ffffff">&amp;</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span><span style="color: #ffffff">&lt;&lt;RXC0))</span><span style="color: #ffffff"></span><span style="color: #ffffff"></span><span style="color: #ffffff"></span><span style="color: #0086f7; font-weight: bold"></span><span style="color: #ffffff"></span><span style="color: #ffffff">);</span>
    
	
<span style="color: #008800; font-style: italic; background-color: #0f140f">/* Get and return received data from buffer */</span>
<span style="color: #fb660a; font-weight: bold">return</span> <span style="color: #ffffff">UDR0;</span>
	
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Transsmit a string</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putstring</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">*</span> <span style="color: #ffffff">s)</span>
<span style="color: #ffffff">{</span>
    <span style="color: #008800; font-style: italic; background-color: #0f140f">// transsmit character until NULL is reached</span>
    <span style="color: #fb660a; font-weight: bold">while</span><span style="color: #ffffff">(*s</span> <span style="color: #ffffff">&gt;</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">uart_putchar(*s++);</span>
<span style="color: #ffffff">}</span>



</pre>
		<p></p>

		<p><a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/www.tinkercad.com">TinkerCad</a> implementation of the program:</p>
		<p><a href="https://www.tinkercad.com/things/cXJt5X0OLiP">https://www.tinkercad.com/things/cXJt5X0OLiP </a></p>
		<p>&nbsp;</p>
		<p>&nbsp;</p>
		</div>
	</div>
		<hr>
	
	

    
		<h2><a name="interrupt">The Timer Overflow Interrupt</a></h2>
		<div class="section">
		
	
    
		<h3><a name="interrupt_caveat">Caveat</a></h3>
		<div class="subsection">
			<p>Today we introduce interrupts in a superficial manner. We will encounter them again in subsequent topics.</p>
		</div>
		
	
    
		<h3><a name="whats_an_interrupt">What’s an interrupt?</a></h3>
		<div class="subsection">
			<p>Refer: Datasheet chapter 12, Section 12.4.</p>
<p>An <em>interrupt</em> is a signal which is generated in response to an internal or external event (or change of state).</p>
<p>Examples:</p>

			<ul><li>Pin change.</li>
<li>Serial transfer complete</li>
<li>Timer overflow</li>
<li>+ plenty more.</li>
</ul>
			<p>Special functions called <em>Interrupt Service Routines</em> (also referred to as <em>interrupt handlers</em>) can be set up to process interrupts and are called in response to an event.</p>

			<ul>
<li>A list of interrupt vectors may be found on datasheet, p74.</li>
<li>Implementing an ISR is much the same as any other function.</li>
<li>The main difference is that we use one of the pre-defined macros to declare our interrupt.</li>
<li>In the present section, we will implement an ISR for the Timer 0 Overflow interrupt.</li>
<li>The ISR will be called automatically every time the Timer/Counter 0 register overflows (this is the event that triggers the interrupt).</li>
</ul>
			<p>When an interrupt occurs and an ISR is implemented for that interrupt:</p>

			<ol><li>The CPU temporarily stops whatever it is doing, but keeps a record of the state of the computation.</li>
<li>It then turns off interrupts so the ISR can run unimpeded.</li>
<li>The ISR is called, like a regular function.</li>
<li>After the ISR finishes, the CPU re-enables interrupts and then continues where it left off.</li>
</ol>
			<p>ISRs must use special global variables to transfer data.</p>

			<ul><li>ISRs cannot accept parameters, and cannot return a value.</li>
<li>Variables that may be changed by an ISR must be marked with the <code>volatile</code> keyword.</li>
<li><code>volatile</code> ensures that the compiler generates the right instructions to let other non-ISR code read the variables.</li>
</ul>
		</div>
		
	
    
		<h3><a name="timer_overflow_demo">Implementing Timer Overflow ISR</a></h3>
		<div class="subsection">
			<p>This subsection shows how to implement a Timer Overflow ISR for Timer 0.</p>

			<ul><li>Timer setup is much the same as the previous example.</li>
<li>We add two more instructions:
				<ul><li><code>TIMSK0&nbsp;=&nbsp;1;</code> enables the Timer Overflow interrupt for Timer 0. The same result would be obtained in this program by writing <code>TIMSK0&nbsp;|=&nbsp;(1&lt;&lt;TOIE0);</code> – clarity is in the eye of the beholder.</li>
<li><code>sei();</code> enables interrupts.</li>
</ul></li>
<li>The ISR is defined as a function with the signature<br>
				<code>ISR(TIMER0_OVF_vect)</code>.</li>
</ul>
			<p>This procedure is demonstrated in <code>example5.c, TimerOverflow0</code></p>
<p style="margin-left: 0.5in;">
</p><pre style="line-height: 1.2; background: #0f140f; color: #BDAE9D; overflow-x: scroll; font-family: monospace; max-width: 100%;"><span class="sc2"></span>
<span class="sc10">#define F_CPU (16000000UL)

#include &lt;stdint.h&gt;
</span><span class="sc10">#include &lt;stdio.h&gt;
</span><span class="sc10">#include &lt;avr/io.h&gt; 
</span><span class="sc10">#include &lt;avr/interrupt.h&gt;
</span><span class="sc10">#include &lt;util/delay.h&gt;
</span><span class="sc10">
</span><span class="sc10"><span style="line-height: 1; background: #0f140f; color: #BDAE9D; font-family: monospace; max-width: 100%;"><span style="color: #008800; font-style: italic; background-color: #0f140f">/*</span> <span style="color: #008800; font-style: italic; background-color: #0f140f"> 
 *  Setting data directions in a data direction register (DDR)</span> <span style="color: #008800; font-style: italic; background-color: #0f140f"> 
 *</span> <span style="color: #008800; font-style: italic; background-color: #0f140f"> 
 *</span> <span style="color: #008800; font-style: italic; background-color: #0f140f"> 
 *  Setting, clearing, and reading bits in registers.</span> <span style="color: #008800; font-style: italic; background-color: #0f140f"> 
 *	reg is the name of a register; pin is the index (0..7)</span> <span style="color: #008800; font-style: italic; background-color: #0f140f"> 
 *  of the bit to set, clear or read.</span> <span style="color: #008800; font-style: italic; background-color: #0f140f"> 
 *  (WRITE_BIT is a combination of CLEAR_BIT &amp; SET_BIT)</span><span style="color: #008800">
 */


</span><span style="color: #ff0007;font-weight: bold;">#define SET_BIT(reg, pin)		    (reg) |= (1 &lt;&lt; (pin))
#define CLEAR_BIT(reg, pin)		  (reg) &amp;= ~(1 &lt;&lt; (pin))
#define WRITE_BIT(reg, pin, value)   (reg) = (((reg) &amp; ~(1 &lt;&lt; (pin))) | ((value) &lt;&lt; (pin)))
#define BIT_VALUE(reg, pin)		  (((reg) &gt;&gt; (pin)) &amp; 1)
#define BIT_IS_SET(reg, pin)	     (BIT_VALUE((reg),(pin))==1) </span></span>

<span style="line-height: 1; background: #0f140f; color: #BDAE9D; font-family: monospace; max-width: 100%;"><span style="color: #008800; font-style: italic; background-color: #0f140f">//Functions declaration</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">setup</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">);
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">process</span>(<span style="color: #cdcaa9; font-weight: bold">void</span>);<span style="color: #cdcaa9; font-weight: bold">
void</span> <span style="color: #ff0086; font-weight: bold">uart_init</span>(<span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">int</span> ubrr)</span><span style="color: #ffffff"></span>;
<span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ff0086; font-weight: bold">uart_getchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span>;<span style="color: #ffffff"></span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">data)</span>;<span style="color: #ffffff"></span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putstring</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">*</span> <span style="color: #ffffff">s)</span>;</span>
<span style="background: #111111;"><span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">ftoa</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">float</span> <span style="color: #ffffff">n,</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">*</span> <span style="color: #ffffff">res,</span> <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">afterpoint);
<span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ff0086; font-weight: bold">intToStr</span>(<span style="color: #cdcaa9; font-weight: bold">int</span> x, <span style="color: #cdcaa9; font-weight: bold">char</span> str[], <span style="color: #cdcaa9; font-weight: bold">int</span> d);
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">reverse</span>(<span style="color: #cdcaa9; font-weight: bold">char</span> * str, <span style="color: #cdcaa9; font-weight: bold">int</span> len);
</span></span>

<span style="line-height: 1; background: #0f140f; color: #BDAE9D; font-family: monospace; max-width: 100%;"><span style="color: #008800; font-style: italic; background-color: #0f140f">//uart definitions</span>
<span style="color: #ff0007; font-weight: bold; font-style: italic; background-color: #0f140f">#define BAUD (9600)
#define MYUBRR (F_CPU/16/BAUD-1)</span></span>


</span><span style="line-height: 1; background: #0f140f; color: #BDAE9D; font-family: monospace; max-width: 100%;"><span style="color: #008800; font-style: italic; background-color: #0f140f">//timer definitions</span>
<span style="color: #ff0007; font-weight: bold; font-style: italic; background-color: #0f140f">#define FREQ (16000000.0)
#define PRESCALE (1024.0)</span></span>

<span class="sc11">void</span> <span class="sc4">setup</span>(<span class="sc11">void</span>) {

    <span style="line-height: 1; background: #0f140f; color: #BDAE9D; font-family: monospace; max-width: 100%;"><span style="color: #008800; font-style: italic; background-color: #0f140f">// initialise uart</span>
      <span style="color: #ffffff">uart_init(MYUBRR);</span></span>

	<span style="color:#008800">// Timer 0 in normal mode, with pre-scaler 1024 ==&gt; ~60Hz overflow.</span>
	<span style="color:#008800">// Timer overflow on.</span>
	<span class="sc11">TCCR0A</span> = <span class="sc4">0</span>;
	<span class="sc11">TCCR0B</span> = <span class="sc4">5</span>; 
	<span class="sc11">TIMSK0</span> = <span class="sc4">1</span>; 

	<span style="color: #008800">/*
	Alternatively:
		CLEAR_BIT(TCCR0B,WGM02);
		SET_BIT(TCCR0B,CS02);
		CLEAR_BIT(TCCR0B,CS01);
		SET_BIT(TCCR0B,CS00);
		SET_BIT(TIMSK0, TOIE0);
	*/</span>

    <span style=" color: #008800">// Enable B5 as output, led on B5</span>	
	<span class="sc11">SET_BIT(DDRB, </span><span class="sc4">5</span><span class="sc11">);</span>

	<span style="color: #008800">// Enable timer overflow, and turn on interrupts.</span>
	<span class="sc11">sei</span>();
}
<span class="sc9"></span><span class="sc11"></span><span class="sc4"></span>

<span class="sc5">volatile</span> <span class="sc9">int</span> <span class="sc11">overflow_counter</span> = <span class="sc4">0</span>;

<span class="sc11">ISR</span>(<span class="sc11">TIMER0_OVF_vect</span>) {
	<span class="sc11">overflow_counter</span> ++;
}

<span class="sc11">void</span> <span class="sc4">process</span>(<span class="sc11">void</span>) {
<span style="color: #cdcaa9; font-weight: bold">    
    char</span> <span style="color: #ffffff">temp_buf[</span><span class="sc4">64</span><span class="sc4" style="color: #ffffff"></span><span style="color: #ffffff">];</span>
   <span class="sc11"> char *ch;</span>

    <span style=" color: #008800">//compute elapsed time</span>
	<span class="sc9">double</span> <span class="sc11">time</span> = ( <span class="sc11">overflow_counter</span> * <span class="sc4">256.0</span> + <span class="sc11">TCNT0</span> ) * <span class="sc10">PRESCALE</span>  / <span class="sc10">FREQ</span>;

<span style="color: #ffffff">    <span style="color: #008800">//convert float to a string</span> 
    ftoa(time, temp_buf, 4);</span>

	 <span style="color: #008800; font-style: italic; background-color: #0f140f">//send serial data</span>
	 <span style="color: #ffffff">uart_putstring((unsigned char *) temp_buf);</span>
	 <span class="sc11">uart_putchar(</span><span class="sc4">'\n'</span><span class="sc11">);</span>	

     <span style=" color: #008800">//flash LED every cycle </span>    
	 <span class="sc11"> PORTB^=(</span><span class="sc4">1</span><span class="sc11">&lt;&lt;PINB5)</span>;
   
	
}

<span class="sc11">int</span> <span class="sc4">main</span>(<span class="sc11">void</span>) {
	<span class="sc11">setup</span>();

	<span class="sc5">for</span> ( ;; ) {
		<span class="sc11">process</span>();
		<span class="sc11">_delay_ms(</span><span class="sc4">1000</span><span class="sc11">);</span>
	}
}<span style="line-height: 1.2; background: #0f140f; color: #BDAE9D; overflow-x: scroll; font-family: monospace; max-width: 100%;">


<span style="color: #008800; font-style: italic; background-color: #0f140f">/********** auxiliary functions *************/<span style="color: #cdcaa9">

<div style="background: #111111;">
<span style="color: #008800; background-color: #0f140f">// Reverses a string 'str' of length 'len' </span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">reverse</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">*</span> <span style="color: #ffffff">str,</span> <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">len)</span> <span style="color: #ffffff">{</span>
  <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">i</span> <span style="color: #ffffff">=</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">,</span> <span style="color: #ffffff">j</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">len</span> <span style="color: #ffffff">-</span> <span style="color: #0086f7; font-weight: bold">1</span><span style="color: #ffffff">,</span> <span style="color: #ffffff">temp;</span>
  <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(i</span> <span style="color: #ffffff">&lt;</span> <span style="color: #ffffff">j)</span> <span style="color: #ffffff">{</span>
    <span style="color: #ffffff">temp</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">str[i];</span>
    <span style="color: #ffffff">str[i]</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">str[j];</span>
    <span style="color: #ffffff">str[j]</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">temp;</span>
    <span style="color: #ffffff">i++;</span>
    <span style="color: #ffffff">j--;</span>
  <span style="color: #ffffff">}</span>
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Converts a given integer x to string str[].  </span>
<span style="color: #008800; font-style: italic; background-color: #0f140f">// d is the number of digits required in the output.  </span>
<span style="color: #008800; font-style: italic; background-color: #0f140f">// If d is more than the number of digits in x,  </span>
<span style="color: #008800; font-style: italic; background-color: #0f140f">// then 0s are added at the beginning. </span>
<span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ff0086; font-weight: bold">intToStr</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">x,</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">str[],</span> <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">d)</span> <span style="color: #ffffff">{</span>
  <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">i</span> <span style="color: #ffffff">=</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">;</span>
  <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(x)</span> <span style="color: #ffffff">{</span>
    <span style="color: #ffffff">str[i++]</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(x</span> <span style="color: #ffffff">%</span> <span style="color: #0086f7; font-weight: bold">10</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">+</span> <span style="color: #0086d2">'0'</span><span style="color: #ffffff">;</span>
    <span style="color: #ffffff">x</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">x</span> <span style="color: #ffffff">/</span> <span style="color: #0086f7; font-weight: bold">10</span><span style="color: #ffffff">;</span>
  <span style="color: #ffffff">}</span>

  <span style="color: #008800; font-style: italic; background-color: #0f140f">// If number of digits required is more, then </span>
  <span style="color: #008800; font-style: italic; background-color: #0f140f">// add 0s at the beginning </span>
  <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(i</span> <span style="color: #ffffff">&lt;</span> <span style="color: #ffffff">d)</span>
    <span style="color: #ffffff">str[i++]</span> <span style="color: #ffffff">=</span> <span style="color: #0086d2">'0'</span><span style="color: #ffffff">;</span>

  <span style="color: #ffffff">reverse(str,</span> <span style="color: #ffffff">i);</span>
  <span style="color: #ffffff">str[i]</span> <span style="color: #ffffff">=</span> <span style="color: #0086d2">'\0'</span><span style="color: #ffffff">;</span>
  <span style="color: #fb660a; font-weight: bold">return</span> <span style="color: #ffffff">i;</span>
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Converts a floating-point/double number to a string. </span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">ftoa</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">float</span> <span style="color: #ffffff">n,</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">*</span> <span style="color: #ffffff">res,</span> <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">afterpoint)</span> <span style="color: #ffffff">{</span>
  <span style="color: #008800; font-style: italic; background-color: #0f140f">// Extract integer part </span>
  <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">ipart</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">int</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">n;</span>

  <span style="color: #008800; font-style: italic; background-color: #0f140f">// Extract floating part </span>
  <span style="color: #cdcaa9; font-weight: bold">float</span> <span style="color: #ffffff">fpart</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">n</span> <span style="color: #ffffff">-</span> <span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">float</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">ipart;</span>

  <span style="color: #008800; font-style: italic; background-color: #0f140f">// convert integer part to string </span>
  <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">i</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">intToStr(ipart,</span> <span style="color: #ffffff">res,</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">);</span>

  <span style="color: #008800; font-style: italic; background-color: #0f140f">// check for display option after point </span>
  <span style="color: #fb660a; font-weight: bold">if</span> <span style="color: #ffffff">(afterpoint</span> <span style="color: #ffffff">!=</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>
    <span style="color: #ffffff">res[i]</span> <span style="color: #ffffff">=</span> <span style="color: #0086d2">'.'</span><span style="color: #ffffff">;</span> <span style="color: #008800; font-style: italic; background-color: #0f140f">// add dot </span>

    <span style="color: #008800; font-style: italic; background-color: #0f140f">// Get the value of fraction part upto given no. </span>
    <span style="color: #008800; font-style: italic; background-color: #0f140f">// of points after dot. The third parameter  </span>
    <span style="color: #008800; font-style: italic; background-color: #0f140f">// is needed to handle cases like 233.007 </span>
    <span style="color: #ffffff">fpart</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">fpart</span> <span style="color: #ffffff">*</span> <span style="color: #ffffff">pow(</span><span style="color: #0086f7; font-weight: bold">10</span><span style="color: #ffffff">,</span> <span style="color: #ffffff">afterpoint);</span>

    <span style="color: #ffffff">intToStr((</span><span style="color: #cdcaa9; font-weight: bold">int</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">fpart,</span> <span style="color: #ffffff">res</span> <span style="color: #ffffff">+</span> <span style="color: #ffffff">i</span> <span style="color: #ffffff">+</span> <span style="color: #0086f7; font-weight: bold">1</span><span style="color: #ffffff">,</span> <span style="color: #ffffff">afterpoint);</span>
  <span style="color: #ffffff">}</span>
<span style="color: #ffffff">}</span>
</div>





</span>/********* serial definitions ****************/</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Initialize the UART</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_init</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">int</span> <span style="color: #ffffff">ubrr)</span> <span style="color: #ffffff">{</span>
	
	<span style="color: #ffffff">UBRR0H</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">)(ubrr&gt;&gt;</span><span style="color: #0086f7; font-weight: bold">8</span><span style="color: #ffffff">);</span>
    <span style="color: #ffffff">UBRR0L</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">)(ubrr);</span>
	<span style="color: #ffffff">UCSR0B</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span> <span style="color: #ffffff">&lt;&lt;</span> <span style="color: #ffffff">RXEN0)</span> <span style="color: #ffffff">|</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span> <span style="color: #ffffff">&lt;&lt;</span> <span style="color: #ffffff">TXEN0);</span>
	<span style="color: #ffffff">UCSR0C</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">3 </span><span style="color: #ffffff">&lt;&lt; UCSZ00);</span>
	
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Transmit a data</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ffffff">data)</span> <span style="color: #ffffff">{</span>
	
    <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(!(</span> <span style="color: #ffffff">UCSR0A</span> <span style="color: #ffffff">&amp;</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span><span style="color: #ffffff">&lt;&lt;UDRE0)));</span> <span style="color: #008800; font-style: italic; background-color: #0f140f">/* Wait for empty transmit buffer*/</span>
    
  	<span style="color: #ffffff">UDR0</span> <span style="color: #ffffff">=</span> <span style="color: #ffffff">data;</span>            <span style="color: #008800; font-style: italic; background-color: #0f140f">/* Put data into buffer, sends the data */</span>
         	
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Receive data</span>
<span style="color: #cdcaa9; font-weight: bold">char</span> <span style="color: #ff0086; font-weight: bold">uart_getchar</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">void</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">{</span>

  <span style="color: #008800; font-style: italic; background-color: #0f140f">/* Wait for data to be received */</span> 
  <span style="color: #fb660a; font-weight: bold">while</span> <span style="color: #ffffff">(</span> <span style="color: #ffffff">!(UCSR0A</span> <span style="color: #ffffff">&amp;</span> <span style="color: #ffffff">(</span><span style="color: #0086f7; font-weight: bold">1</span><span style="color: #ffffff">&lt;&lt;RXC0))</span> <span style="color: #ffffff">);</span>
    
	
<span style="color: #008800; font-style: italic; background-color: #0f140f">/* Get and return received data from buffer */</span>
<span style="color: #fb660a; font-weight: bold">return</span> <span style="color: #ffffff">UDR0;</span>
	
<span style="color: #ffffff">}</span>

<span style="color: #008800; font-style: italic; background-color: #0f140f">// Transmit a string</span>
<span style="color: #cdcaa9; font-weight: bold">void</span> <span style="color: #ff0086; font-weight: bold">uart_putstring</span><span style="color: #ffffff">(</span><span style="color: #cdcaa9; font-weight: bold">unsigned</span> <span style="color: #cdcaa9; font-weight: bold">char</span><span style="color: #ffffff">*</span> <span style="color: #ffffff">s)</span>
<span style="color: #ffffff">{</span>
    <span style="color: #008800; font-style: italic; background-color: #0f140f">// transmit character until NULL is reached</span>
    <span style="color: #fb660a; font-weight: bold">while</span><span style="color: #ffffff">(*s</span> <span style="color: #ffffff">&gt;</span> <span style="color: #0086f7; font-weight: bold">0</span><span style="color: #ffffff">)</span> <span style="color: #ffffff">uart_putchar(*s++);</span>
<span style="color: #ffffff">}</span>
</span>


<span class="sc10"></span>
</pre>
		<p></p>
		<p><a href="https://blackboard.qut.edu.au/bbcswebdav/pid-8394131-dt-content-rid-31013124_1/courses/CAB202_20se1/Topic09/www.tinkercad.com">TinkerCad</a> implementation of the program:</p>
		<p><a href="https://www.tinkercad.com/things/dmEso1BGcrW">https://www.tinkercad.com/things/dmEso1BGcrW</a></p>
		<ul><li>In the ISR, we increment a counter to record how many times the timer has overflowed.</li>
<li>In process, we multiply the counter by 256 (the number of ticks per overflow) and add the residual value of <code>TCNT0</code> to get the total number of elapsed ticks. This is then multiplied by the scaling factor to convert to the number of elapsed seconds since the program started.</li>
<li>Note that in this implementation the counter wraps around and becomes negative when it passes 32,767. We could address this by counting with some wider numeric type.</li>
</ul>
		</div>
	</div>
		<hr>

<h2><a name="exercices">Additional exercices:</a></h2>
<div class="section"></div>
	
	<div class="subsection">
	  <ol>
	    <li>Use timers to flash three LEDs at 1Hz, 3Hz, 10Hz, respectively.</li>
	    <li>Use a switch to trigger an interrupt. This interrupt will perform an action, for example toggle the state of an LED.</li>
      </ol>
	</div>
	
	
	

    
		<p>&nbsp;</p>
		<hr>
		<h2><a name="appendices">Appendices</a></h2>
		<div class="section">
			
			

		
	
    
		<h3><a name="uart_interrupt">Appendix 1: Interrupt-Based UART</a></h3>
		<div class="subsection">
			
			<ul>
			  <li>This example provides an alternative to perform UART communications using interrupts. It does work in a non-blocking mode.	Link	to	example here: <a href="https://www.tinkercad.com/things/kcQ9NqHHy3Q">https://www.tinkercad.com/things/kcQ9NqHHy3Q</a></li>
			</ul>
		</div>
		<h3><a name="packed_boolean_array">Appendix 2: Bit-packed boolean arrays</a></h3>
		<div class="subsection">
			<ul><li>Microcontrollers typically have limited RAM, so when writing complex programs we take every chance to economise on memory use.</li>
<li>This subsection shows how we can use bit-level operations in an orderly way to pack multiple boolean values into simple variables, emulating a packed array of boolean.</li>
<li>The key idea is as follows:
				<ul><li>A variable of type <code>uint8_t</code> has 8 bits, so it can be used to remember up to 8 independent YES/NO values.</li>
<li>A variable of type <code>uint16_t</code> has 16 bits, so it can be used to remember up to 16 independent YES/NO values.</li>
<li>A variable of type <code>uint32_t</code> has 32 bits, so it can be used to remember up to 32 independent YES/NO values.</li>
</ul></li>
<li>The trick is to use bitwise operators:
				<ul><li><code>SET_BIT</code> stores a YES value in a packed array – <code>SET_BIT(collection,i)</code> is analogous to <code>collection[i]&nbsp;=&nbsp;true</code>;</li>
<li><code>CLEAR_BIT</code> stores a NO value in a packed array – <code>CLEAR_BIT(collection,i)</code> is analogous to <code>collection[i]&nbsp;=&nbsp;false</code>;</li>
<li><code>BIT_IS_SET</code> asks if the value is YES – <code>if&nbsp;(BIT_IS_SET(collection,i))&nbsp;{&nbsp;/*&nbsp;do&nbsp;something&nbsp;*/&nbsp;}</code> is analogous to <code>if&nbsp;(collection[i])&nbsp;{&nbsp;/*&nbsp;do&nbsp;something&nbsp;*/&nbsp;}</code>;</li>
</ul></li>
<li>Practical application:
				<ul><li>Remembering the state of a collection of switches.</li>
</ul></li>
</ul>
		</div> 

		 

		
	
    
		<h3><a name="cheat_sheet">Appendix 3: Digital I/O Cheat Sheet</a></h3>
		<div class="subsection">
			<p>Code snippets for frequently used registers:</p>

			<table cellspacing="0" border="1">
				<tbody><tr><td width="56">Digital I/O</td><td width="172">Data direction register</td><td width="182">Detect</td><td width="163">Turn on</td><td width="180">Turn Off</td></tr>
				<tr>
				  <td>Switch connected to PF6</td><td><code>CLEAR_BIT(DDRF,&nbsp;6)</code></td><td><code>BIT_IS_SET(PINF,&nbsp;6)</code></td><td>n/a</td><td>n/a</td></tr>
				<tr>
				  <td>LED connected to PB2</td><td><code>SET_BIT(DDRB,&nbsp;2)&nbsp;&nbsp;</code></td><td>n/a</td><td><code>SET_BIT(PORTB,&nbsp;2)</code></td><td><code>CLEAR_BIT(PORTB,&nbsp;2)</code></td></tr>
			</tbody></table>
			
			<ul></ul>
		</div> 
	</div>
		<hr>

	<p style="text-align:center"><em>The End</em></p>
	<hr>
</body></html>